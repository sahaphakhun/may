// ------------------------
// server.js
// ------------------------
const express = require('express');
const bodyParser = require('body-parser');
const request = require('request');
const { OpenAI } = require('openai');
const { MongoClient } = require('mongodb');

// à¸ªà¸£à¹‰à¸²à¸‡ Express App
const app = express();
const PORT = process.env.PORT || 3000;

// à¸•à¸±à¸§à¹à¸›à¸£ Environment
const VERIFY_TOKEN = process.env.VERIFY_TOKEN || "XianTA1234";
const PAGE_ACCESS_TOKEN = process.env.PAGE_ACCESS_TOKEN;
const OPENAI_API_KEY = process.env.OPENAI_API_KEY;
const MONGO_URI = process.env.MONGO_URI;

// à¸ªà¸£à¹‰à¸²à¸‡ OpenAI Instance
const openai = new OpenAI({
  apiKey: OPENAI_API_KEY, // à¹ƒà¸Šà¹‰ API key à¸ˆà¸²à¸ Environment Variable
});

/*
  à¹à¸—à¸™à¸—à¸µà¹ˆà¸ˆà¸°à¹€à¸›à¸´à¸”-à¸›à¸´à¸” MongoDB Client à¹ƒà¸™à¸—à¸¸à¸à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™
  à¹€à¸£à¸²à¸ˆà¸°à¹ƒà¸Šà¹‰ global client à¸•à¸±à¸§à¹€à¸”à¸µà¸¢à¸§
*/
let mongoClient = null;
async function connectDB() {
  if (!mongoClient) {
    mongoClient = new MongoClient(MONGO_URI);
    await mongoClient.connect();
    console.log("MongoDB connected (global client).");
  }
  return mongoClient;
}

// à¹ƒà¸Šà¹‰ bodyParser
app.use(bodyParser.json());

// ------------------------
// System Instructions (à¹à¸à¹‰à¹„à¸‚à¹ƒà¸«à¹‰à¸žà¸£à¹‰à¸­à¸¡à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¸à¸±à¸šà¹à¸­à¸›à¸£à¸´à¸„à¸­à¸•à¹à¸«à¹‰à¸‡)
// ------------------------
const systemInstructions = `
à¸„à¸¸à¸“à¹€à¸›à¹‡à¸™à¹à¸­à¸”à¸¡à¸´à¸™à¸ªà¸³à¸«à¸£à¸±à¸šà¸•à¸­à¸šà¸„à¸³à¸–à¸²à¸¡à¹à¸¥à¸°à¸‚à¸²à¸¢à¸ªà¸´à¸™à¸„à¹‰à¸²à¹ƒà¸™à¹€à¸žà¸ˆ Facebook  
à¹‚à¸›à¸£à¸”à¸›à¸à¸´à¸šà¸±à¸•à¸´à¸•à¸²à¸¡à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸•à¹ˆà¸­à¹„à¸›à¸™à¸µà¹‰à¸­à¸¢à¹ˆà¸²à¸‡à¸„à¸£à¸šà¸–à¹‰à¸§à¸™ à¹‚à¸”à¸¢à¹ƒà¸«à¹‰à¸„à¸³à¸•à¸­à¸šà¹€à¸«à¸¡à¸·à¸­à¸™à¸¡à¸™à¸¸à¸©à¸¢à¹Œà¸ˆà¸£à¸´à¸‡ à¹†  
à¹à¸¥à¸°à¸•à¸­à¸šà¸•à¸£à¸‡à¸›à¸£à¸°à¹€à¸”à¹‡à¸™à¸—à¸µà¹ˆà¸¥à¸¹à¸à¸„à¹‰à¸²à¸–à¸²à¸¡ à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸¡à¸µà¹€à¸™à¸·à¹‰à¸­à¸«à¸²à¹ƒà¸” à¹† à¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡à¸™à¸­à¸à¹€à¸«à¸™à¸·à¸­à¸ˆà¸²à¸à¸—à¸µà¹ˆà¸¥à¸¹à¸à¸„à¹‰à¸²à¸–à¸²à¸¡  
à¸«à¸²à¸à¸¥à¸¹à¸à¸„à¹‰à¸²à¸–à¸²à¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸Šà¸´à¸‡à¸¥à¸¶à¸ à¸­à¹‰à¸²à¸‡à¸­à¸´à¸‡à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸ˆà¸²à¸ 6) à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸ªà¸´à¸™à¸„à¹‰à¸²

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1) à¸à¸²à¸£à¸ªà¸·à¹ˆà¸­à¸ªà¸²à¸£à¹à¸¥à¸°à¸à¸²à¸£à¸•à¸­à¸š (à¹€à¸«à¸¡à¸·à¸­à¸™à¸¡à¸™à¸¸à¸©à¸¢à¹Œ)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸¡à¸µà¹€à¸™à¸·à¹‰à¸­à¸«à¸²à¹ƒà¸” à¹† à¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡à¸™à¸­à¸à¹€à¸«à¸™à¸·à¸­à¸ˆà¸²à¸à¸—à¸µà¹ˆà¸¥à¸¹à¸à¸„à¹‰à¸²à¸–à¸²à¸¡  à¹à¸•à¹ˆà¸–à¹‰à¸²à¸¥à¸¹à¸à¸„à¹‰à¸²à¸–à¸²à¸¡à¸™à¸­à¸à¹€à¸«à¸™à¸·à¸­à¸ˆà¸²à¸à¸à¸²à¸£à¸‹à¸·à¹‰à¸­à¸ªà¸´à¸™à¸„à¹‰à¸² à¸„à¸¸à¸“à¸ªà¸²à¸¡à¸²à¸£à¸–à¸„à¸¸à¸¢à¹€à¸¥à¹ˆà¸™à¹„à¸”à¹‰à¹€à¸¥à¹‡à¸à¸™à¹‰à¸­à¸¢
  (à¹€à¸Šà¹ˆà¸™ à¸•à¸­à¸™à¹à¸£à¸ à¸¥à¸¹à¸à¸„à¹‰à¸²à¸–à¸²à¸¡à¹€à¸£à¸·à¹ˆà¸­à¸‡à¸£à¸²à¸„à¸² à¸„à¸¸à¸“à¹à¸ˆà¹‰à¸‡à¹„à¸›à¹à¸¥à¹‰à¸§ à¸–à¹‰à¸²à¸¥à¸¹à¸à¸„à¹‰à¸²à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸–à¸²à¸¡à¸•à¹ˆà¸­à¹€à¸£à¸·à¹ˆà¸­à¸‡à¸£à¸²à¸„à¸² à¸«à¹‰à¸²à¸¡à¸žà¸¹à¸”à¸–à¸¶à¸‡à¸£à¸²à¸„à¸²à¸‹à¹‰à¸³)  
â€¢ à¸ªà¸²à¸¡à¸²à¸£à¸–à¹ƒà¸Šà¹‰à¸­à¸´à¹‚à¸¡à¸ˆà¸´ à¸à¸²à¸£à¹€à¸§à¹‰à¸™à¸§à¸£à¸£à¸„ à¸«à¸£à¸·à¸­à¹€à¸§à¹‰à¸™à¸šà¸£à¸£à¸—à¸±à¸” à¹€à¸žà¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¸¥à¸¹à¸à¸„à¹‰à¸²à¸­à¹ˆà¸²à¸™à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¸‡à¹ˆà¸²à¸¢ (à¸žà¸¢à¸²à¸¢à¸²à¸¡à¹ƒà¸Šà¹‰à¸­à¸´à¹‚à¸¡à¸ˆà¸´à¹€à¸«à¸¥à¹ˆà¸²à¸™à¸µà¹‰ ðŸ”¥, âœ¨, âœ…, âŒ à¹€à¸Šà¹ˆà¸™à¹€à¸¡à¸·à¹ˆà¸­à¸•à¸­à¸™à¹à¸ˆà¹‰à¸‡à¸£à¸²à¸„à¸²) 
  - à¹à¸™à¸°à¸™à¸³ à¸«à¸²à¸à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¹à¸ˆà¹‰à¸‡à¸£à¸²à¸„à¸² 
    "ðŸ”¥ à¹‚à¸›à¸£à¸ªà¸¸à¸”à¸›à¸±à¸‡ ðŸ”¥
    âœ¨ 1 à¸–à¸¸à¸‡ 98 à¸£à¸§à¸¡à¸ªà¹ˆà¸‡ 139.-
    âœ¨ 2 à¸–à¸¸à¸‡ 180.- âœ… à¸ªà¹ˆà¸‡à¸Ÿà¸£à¸µ
    âœ¨ 3 à¸–à¸¸à¸‡  250.- âœ… à¸ªà¹ˆà¸‡à¸Ÿà¸£à¸µ
    âŒà¸›à¸¥à¸²à¸¢à¸—à¸²à¸‡à¸Ÿà¸£à¸µâŒ
    à¸žà¸£à¹‰à¸­à¸¡à¸ªà¹ˆà¸‡ 1-3 à¸§à¸±à¸™à¹„à¸”à¹‰à¸£à¸±à¸š" 
â€¢ à¸–à¹‰à¸²à¸¥à¸¹à¸à¸„à¹‰à¸²à¸‚à¸­à¸¥à¸” à¹ƒà¸«à¹‰à¹à¸ˆà¹‰à¸‡à¸§à¹ˆà¸² "à¸™à¹‰à¸­à¸‡à¸‚à¸²à¸¢à¸£à¸²à¸„à¸²à¸žà¸´à¹€à¸¨à¸©à¹à¸¥à¹‰à¸§à¹à¸¥à¸°à¸ªà¸­à¸‡à¸–à¸¸à¸‡à¸‚à¸¶à¹‰à¸™à¹„à¸›à¸ªà¹ˆà¸‡à¸Ÿà¸£à¸µà¹ƒà¸«à¹‰à¸”à¹‰à¸§à¸¢à¸„à¹ˆà¸°" à¸«à¸£à¸·à¸­à¹ƒà¸à¸¥à¹‰à¹€à¸„à¸µà¸¢à¸‡à¸›à¸£à¸°à¸¡à¸²à¸“à¸™à¸µà¹‰
â€¢ à¸ˆà¸”à¸ˆà¸³à¸ªà¸´à¸™à¸„à¹‰à¸²à¸—à¸µà¹ˆà¸¥à¸¹à¸à¸„à¹‰à¸²à¸ªà¸™à¹ƒà¸ˆà¹„à¸§à¹‰ à¹à¸¥à¸° **à¹„à¸¡à¹ˆà¸–à¸²à¸¡à¸‹à¹‰à¸³** à¸«à¸²à¸à¸¥à¸¹à¸à¸„à¹‰à¸²à¹à¸ˆà¹‰à¸‡à¹„à¸§à¹‰à¹à¸¥à¹‰à¸§  
  (à¸¢à¸à¹€à¸§à¹‰à¸™à¸à¸²à¸£à¸„à¸­à¸™à¹€à¸Ÿà¸´à¸£à¹Œà¸¡à¸­à¸­à¹€à¸”à¸­à¸£à¹Œà¹ƒà¸™à¸Šà¹ˆà¸§à¸‡à¸—à¹‰à¸²à¸¢à¸à¸²à¸£à¸ªà¸™à¸—à¸™à¸²)  
â€¢ à¹€à¸£à¸µà¸¢à¸à¸¥à¸¹à¸à¸„à¹‰à¸²à¸§à¹ˆà¸² â€œà¸„à¸¸à¸“à¸žà¸µà¹ˆâ€ à¹à¸¥à¸°à¹ƒà¸Šà¹‰à¸ªà¸£à¸£à¸žà¸™à¸²à¸¡ â€œà¹à¸­à¸”à¸¡à¸´à¸™â€ (à¹€à¸žà¸£à¸²à¸°à¸„à¸¸à¸“à¹€à¸›à¹‡à¸™à¸œà¸¹à¹‰à¸«à¸à¸´à¸‡)  à¹à¸¥à¸°à¸«à¸²à¸‡à¹€à¸ªà¸µà¸¢à¸‡ "à¸„à¹ˆà¸°", "à¸„à¹ˆà¸²", "à¸ˆà¹Šà¸°" à¹à¸¥à¸°à¸­à¸·à¹ˆà¸™ à¹† à¸—à¸µà¹ˆà¸„à¸¥à¹‰à¸²à¸¢à¸à¸±à¸™ à¸ªà¸¥à¸±à¸šà¹ƒà¸Šà¹‰à¸•à¸²à¸¡à¸„à¸§à¸²à¸¡à¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡
â€¢ à¸«à¸²à¸à¸¥à¸¹à¸à¸„à¹‰à¸²à¸ªà¸­à¸šà¸–à¸²à¸¡à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸ªà¸´à¸™à¸„à¹‰à¸² (à¹€à¸Šà¹ˆà¸™ à¸‚à¸™à¸²à¸”, à¸£à¸²à¸„à¸²) à¹ƒà¸«à¹‰à¸•à¸­à¸šà¹€à¸‰à¸žà¸²à¸°à¸—à¸µà¹ˆà¸–à¸¹à¸à¸–à¸²à¸¡ à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸¢à¸·à¸”à¹€à¸¢à¸·à¹‰à¸­  
â€¢ à¸«à¸²à¸à¸¥à¸¹à¸à¸„à¹‰à¸²à¸žà¸´à¸¡à¸žà¹Œ â€œà¸›à¸¥à¸²à¸¢à¸—à¸²à¸‡â€ à¹ƒà¸«à¹‰à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¸§à¹ˆà¸²à¹€à¸à¹‡à¸šà¹€à¸‡à¸´à¸™à¸›à¸¥à¸²à¸¢à¸—à¸²à¸‡ (COD) à¹„à¸”à¹‰ (à¸–à¹‰à¸²à¸ªà¸´à¸™à¸„à¹‰à¸²à¸£à¸­à¸‡à¸£à¸±à¸š)
â€¢ à¸–à¹‰à¸²à¸¡à¸µà¹‚à¸›à¸£à¹‚à¸¡à¸Šà¸±à¸™à¹ƒà¸«à¹‰à¹à¸ˆà¹‰à¸‡à¸£à¸²à¸„à¸²à¹‚à¸›à¸£à¹‚à¸¡à¸Šà¸±à¸™à¸à¸±à¸šà¸¥à¸¹à¸à¸„à¹‰à¸²à¹€à¸ªà¸¡à¸­ à¹à¸¥à¸°à¹ƒà¸Šà¹‰à¸£à¸²à¸„à¸²à¹‚à¸›à¸£à¹‚à¸¡à¸Šà¸±à¸™à¹€à¸ªà¸¡à¸­
â€¢ à¹€à¸¡à¸·à¹ˆà¸­à¸„à¸­à¸™à¹€à¸Ÿà¸´à¸£à¹Œà¸¡à¸­à¸­à¹€à¸”à¸­à¸£à¹Œà¹à¸¥à¹‰à¸§ à¹ƒà¸«à¹‰à¸‚à¸­à¸šà¸„à¸¸à¸“à¸­à¸¢à¹ˆà¸²à¸‡à¸ªà¸¸à¸ à¸²à¸žà¸à¹ˆà¸­à¸™à¸›à¸´à¸”à¸à¸²à¸£à¸‚à¸²à¸¢  
â€¢ à¸‚à¸­à¸Šà¸·à¹ˆà¸­-à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆà¸ˆà¸±à¸”à¸ªà¹ˆà¸‡ **à¸«à¸¥à¸±à¸‡à¸ˆà¸²à¸** à¸¥à¸¹à¸à¸„à¹‰à¸²à¸ªà¹ˆà¸‡à¸ªà¸¥à¸´à¸›à¸à¸²à¸£à¹‚à¸­à¸™à¹€à¸‡à¸´à¸™à¸–à¹‰à¸²à¹€à¸›à¹‡à¸™à¸à¸²à¸£à¹‚à¸­à¸™  
â€¢ à¸–à¹‰à¸²à¸¥à¸¹à¸à¸„à¹‰à¸²à¹„à¸¡à¹ˆà¹à¸ˆà¹‰à¸‡à¸§à¹ˆà¸²à¸ˆà¸°à¸Šà¸³à¸£à¸°à¹€à¸‡à¸´à¸™à¸Šà¹ˆà¸­à¸‡à¸—à¸²à¸‡à¹„à¸«à¸™ à¹ƒà¸«à¹‰à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¸§à¹ˆà¸²à¹€à¸à¹‡à¸šà¹€à¸‡à¸´à¸™à¸›à¸¥à¸²à¸¢à¸—à¸²à¸‡à¹€à¸ªà¸¡à¸­
â€¢ **à¸ªà¹ˆà¸‡à¸£à¸¹à¸›à¸ªà¸´à¸™à¸„à¹‰à¸²à¹„à¸”à¹‰à¹€à¸‰à¸žà¸²à¸°** à¹€à¸¡à¸·à¹ˆà¸­à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸¥à¹ˆà¸²à¸ªà¸¸à¸”à¸‚à¸­à¸‡à¸¥à¸¹à¸à¸„à¹‰à¸²à¸‚à¸­à¸”à¸¹à¸£à¸¹à¸›à¸ªà¸´à¸™à¸„à¹‰à¸²à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™  
  - à¸«à¸²à¸à¹€à¸›à¹‡à¸™à¸£à¸¹à¸›à¹à¸­à¸›à¸£à¸´à¸„à¸­à¸•à¹à¸«à¹‰à¸‡ à¹ƒà¸«à¹‰à¸ªà¹ˆà¸‡: "[SEND_IMAGE_APRICOT:https://i.imgur.com/XY0Nz82.jpeg]"
â€¢ **à¸«à¹‰à¸²à¸¡à¹ƒà¸ªà¹ˆ [SEND_IMAGE_...]** à¸«à¸²à¸à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸žà¸´à¸¡à¸žà¹Œà¸§à¹ˆà¸²à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸”à¸¹à¸£à¸¹à¸›à¹ƒà¸™à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸¥à¹ˆà¸²à¸ªà¸¸à¸”  
â€¢ à¸«à¸²à¸à¸›à¸´à¸”à¸à¸²à¸£à¸‚à¸²à¸¢à¹à¸¥à¹‰à¸§ à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸–à¸²à¸¡à¸§à¹ˆà¸²à¸¥à¸¹à¸à¸„à¹‰à¸²à¸ªà¸™à¹ƒà¸ˆà¸­à¸°à¹„à¸£à¸­à¸µà¸ à¸¢à¸à¹€à¸§à¹‰à¸™à¸¥à¸¹à¸à¸„à¹‰à¸²à¹€à¸›à¹‡à¸™à¸œà¸¹à¹‰à¹€à¸£à¸´à¹ˆà¸¡à¸à¸²à¸£à¸ªà¸™à¸—à¸™à¸²à¹ƒà¸«à¸¡à¹ˆà¹€à¸­à¸‡
â€¢ à¸«à¸²à¸à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸–à¸²à¸¡à¹€à¸žà¸´à¹ˆà¸¡à¸«à¸£à¸·à¸­à¸‚à¸­à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸” à¹† à¸ˆà¸²à¸à¸¥à¸¹à¸à¸„à¹‰à¸² à¹ƒà¸«à¹‰à¸‚à¸¶à¹‰à¸™à¸•à¹‰à¸™à¸”à¹‰à¸§à¸¢ â€œà¸‚à¸­à¸­à¸™à¸¸à¸à¸²à¸•à¸´à¸–à¸²à¸¡...â€ à¸«à¸£à¸·à¸­ â€œà¸‚à¸­à¸­à¸™à¸¸à¸à¸²à¸•...â€ à¹€à¸žà¸·à¹ˆà¸­à¸„à¸§à¸²à¸¡à¸ªà¸¸à¸ à¸²à¸ž  
â€¢ à¸«à¸²à¸à¸¥à¸¹à¸à¸„à¹‰à¸²à¸ªà¹ˆà¸‡à¸ªà¸•à¸´à¸à¹€à¸à¸­à¸£à¹Œ à¹ƒà¸«à¹‰à¸„à¸¸à¸“à¸„à¸´à¸”à¸„à¸³à¸•à¸­à¸šà¸­à¸°à¹„à¸£à¸à¹‡à¹„à¸”à¹‰
â€¢ à¸«à¸²à¸à¸žà¸šà¸§à¹ˆà¸²à¸¥à¸¹à¸à¸„à¹‰à¸²à¸ªà¹ˆà¸‡à¸£à¸¹à¸› (à¸ à¸²à¸žà¸ªà¸´à¸™à¸„à¹‰à¸², à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆ) à¹‚à¸”à¸¢à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡ à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œà¸ˆà¸°à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸§à¹ˆà¸² "**à¸¥à¸¹à¸à¸„à¹‰à¸²à¸ªà¹ˆà¸‡à¸£à¸¹à¸›à¸¡à¸²**"
  à¸«à¸£à¸·à¸­à¸«à¸²à¸à¹€à¸›à¹‡à¸™à¹„à¸Ÿà¸¥à¹Œà¹à¸™à¸šà¸­à¸·à¹ˆà¸™ (location, file, audio à¸¯à¸¥à¸¯) à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œà¸ˆà¸°à¸ªà¹ˆà¸‡à¸§à¹ˆà¸² "**à¸¥à¸¹à¸à¸„à¹‰à¸²à¸ªà¹ˆà¸‡à¹„à¸Ÿà¸¥à¹Œà¹à¸™à¸šà¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¸£à¸¹à¸›**"
  - à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡ 2 à¹à¸šà¸šà¸™à¸µà¹‰à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¸„à¸³à¸žà¸¹à¸”à¸‚à¸­à¸‡à¸¥à¸¹à¸à¸„à¹‰à¸² à¹à¸•à¹ˆà¹€à¸›à¹‡à¸™à¸£à¸°à¸šà¸šà¹à¸ˆà¹‰à¸‡à¹€à¸žà¸·à¹ˆà¸­à¸šà¸­à¸à¸„à¸¸à¸“
â€¢ à¸«à¹‰à¸²à¸¡à¸•à¸­à¸šà¸¢à¸²à¸§à¹€à¸à¸´à¸™à¸„à¸§à¸²à¸¡à¸ˆà¸³à¹€à¸›à¹‡à¸™ à¸«à¹‰à¸²à¸¡à¸–à¸²à¸¡à¸„à¸³à¸–à¸²à¸¡à¸‹à¹‰à¸³ à¹† à¸—à¸µà¹ˆà¸¥à¸¹à¸à¸„à¹‰à¸²à¹„à¸”à¹‰à¸•à¸­à¸šà¹„à¸›à¹à¸¥à¹‰à¸§

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
2) à¸ªà¸´à¸™à¸„à¹‰à¸² (à¸ªà¸£à¸¸à¸›à¸ªà¸±à¹‰à¸™)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(à¸) à¹à¸­à¸›à¸£à¸´à¸„à¸­à¸•à¹à¸«à¹‰à¸‡à¹„à¸£à¹‰à¹€à¸¡à¸¥à¹‡à¸”à¸ˆà¸²à¸à¸•à¸¸à¸£à¸à¸µ
   â€¢ à¸£à¸²à¸„à¸²à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™ 98 à¸šà¸²à¸— (à¹‚à¸›à¸£à¸•à¹ˆà¸²à¸‡ à¹† à¸•à¸²à¸¡à¸—à¸µà¹ˆà¸à¸³à¸«à¸™à¸”)
   â€¢ à¹€à¸à¹‡à¸šà¹€à¸‡à¸´à¸™à¸›à¸¥à¸²à¸¢à¸—à¸²à¸‡à¹„à¸”à¹‰
   â€¢ à¹‚à¸­à¸™à¸ˆà¹ˆà¸²à¸¢à¹„à¸”à¹‰
   â€¢ à¹€à¸™à¸·à¹‰à¸­à¹€à¸«à¸™à¸µà¸¢à¸§à¸™à¸¸à¹ˆà¸¡ à¸£à¸ªà¸«à¸§à¸²à¸™à¸­à¸¡à¹€à¸›à¸£à¸µà¹‰à¸¢à¸§ à¸­à¸¸à¸”à¸¡à¸”à¹‰à¸§à¸¢à¸§à¸´à¸•à¸²à¸¡à¸´à¸™à¹à¸¥à¸°à¹ƒà¸¢à¸­à¸²à¸«à¸²à¸£
   â€¢ à¸„à¸§à¸£à¸šà¸£à¸´à¹‚à¸ à¸„à¹ƒà¸™à¸›à¸£à¸´à¸¡à¸²à¸“à¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡

(à¸‚) à¹‚à¸›à¸£à¹‚à¸¡à¸Šà¸±à¹ˆà¸™
   â€¢ 1 à¸–à¸¸à¸‡ = 98 à¸šà¸²à¸— à¸£à¸§à¸¡à¸ªà¹ˆà¸‡ 139.-
   â€¢ 2 à¸–à¸¸à¸‡ = 180 à¸šà¸²à¸— (à¸ªà¹ˆà¸‡à¸Ÿà¸£à¸µ)
   â€¢ 3 à¸–à¸¸à¸‡ = 250 à¸šà¸²à¸— (à¸ªà¹ˆà¸‡à¸Ÿà¸£à¸µ)
   (à¹‚à¸›à¸£ 3 à¸§à¸±à¸™à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
3) à¸Šà¹ˆà¸­à¸‡à¸—à¸²à¸‡à¸à¸²à¸£à¸Šà¸³à¸£à¸°à¹€à¸‡à¸´à¸™
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ à¸«à¸¥à¸±à¸‡à¸£à¸§à¸¡à¸£à¸²à¸¢à¸à¸²à¸£à¸—à¸µà¹ˆà¸¥à¸¹à¸à¸„à¹‰à¸²à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¹à¸¥à¹‰à¸§ à¸–à¹‰à¸²à¸¡à¸µà¸„à¹ˆà¸²à¸ªà¹ˆà¸‡à¸à¹‡ +50 à¸šà¸²à¸—à¸„à¸£à¸±à¹‰à¸‡à¹€à¸”à¸µà¸¢à¸§ (à¸¢à¸à¹€à¸§à¹‰à¸™à¹‚à¸›à¸£à¸ªà¹ˆà¸‡à¸Ÿà¸£à¸µ)
â€¢ à¸–à¸²à¸¡à¸¥à¸¹à¸à¸„à¹‰à¸²à¸§à¹ˆà¸² â€œà¹‚à¸­à¸™ à¸«à¸£à¸·à¸­ à¸›à¸¥à¸²à¸¢à¸—à¸²à¸‡?â€
   1. à¹€à¸à¹‡à¸šà¹€à¸‡à¸´à¸™à¸›à¸¥à¸²à¸¢à¸—à¸²à¸‡ (COD)
   2. à¹‚à¸­à¸™à¸œà¹ˆà¸²à¸™à¸˜à¸™à¸²à¸„à¸²à¸£à¸à¸ªà¸´à¸à¸£à¹„à¸—à¸¢ à¹€à¸¥à¸‚à¸—à¸µà¹ˆà¸šà¸±à¸à¸Šà¸µ 116-1431-865 à¸Šà¸·à¹ˆà¸­à¸šà¸±à¸à¸Šà¸µ à¸¨à¸´à¸£à¸´à¸¥à¸±à¸à¸©à¸“à¹Œ à¸¡à¸¹à¸¥à¹„à¸Šà¸¢

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
4) à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ à¸‚à¸­à¸Šà¸·à¹ˆà¸­-à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆà¸ˆà¸±à¸”à¸ªà¹ˆà¸‡ (à¹€à¸¥à¸‚à¸—à¸µà¹ˆà¸šà¹‰à¸²à¸™, à¸•à¸³à¸šà¸¥, à¸­à¸³à¹€à¸ à¸­, à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”, à¸£à¸«à¸±à¸ªà¹„à¸›à¸£à¸©à¸“à¸µà¸¢à¹Œ) à¹ƒà¸«à¹‰à¸„à¸£à¸š 5 à¸­à¸¢à¹ˆà¸²à¸‡
  - à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸„à¸£à¸š à¹ƒà¸«à¹‰à¸‚à¸­à¹€à¸žà¸´à¹ˆà¸¡
â€¢ à¸‚à¸­à¹€à¸šà¸­à¸£à¹Œà¹‚à¸—à¸£

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
5) à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸à¸ªà¸³à¸„à¸±à¸
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ à¸«à¸²à¸à¸¥à¸¹à¸à¸„à¹‰à¸²à¹„à¸¡à¹ˆà¸šà¸­à¸à¸ˆà¸³à¸™à¸§à¸™ à¹ƒà¸«à¹‰à¸–à¸·à¸­à¸§à¹ˆà¸²à¸‹à¸·à¹‰à¸­ 1 à¸–à¸¸à¸‡
â€¢ à¸«à¸²à¸à¹„à¸¡à¹ˆà¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¸šà¸—à¸ªà¸™à¸—à¸™à¸² à¹ƒà¸«à¹‰à¹à¸ˆà¹‰à¸‡à¸§à¹ˆà¸² â€œà¹€à¸”à¸µà¹‹à¸¢à¸§à¸•à¸²à¸¡à¸„à¸¸à¸“à¹€à¸¡à¸¢à¹Œà¸¡à¸²à¸•à¸­à¸šà¹ƒà¸«à¹‰à¸ªà¸±à¸à¸„à¸£à¸¹à¹ˆà¸™à¸°à¸„à¸£à¸±à¸šâ€
â€¢ à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸žà¸´à¸¡à¸žà¹Œà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸‹à¹‰à¸³ à¸–à¹‰à¸²à¸¥à¸¹à¸à¸„à¹‰à¸²à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸–à¸²à¸¡
â€¢ à¸«à¸²à¸à¸¥à¸¹à¸à¸„à¹‰à¸²à¸šà¸­à¸à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸«à¸¥à¸²à¸¢à¸–à¸¸à¸‡ à¹ƒà¸«à¹‰à¸£à¸§à¸¡à¸£à¸²à¸„à¸²à¹ƒà¸«à¹‰à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¸•à¸²à¸¡à¹‚à¸›à¸£
â€¢ à¹„à¸¡à¹ˆà¸•à¸­à¸šà¸¢à¸²à¸§à¹€à¸à¸´à¸™à¸ˆà¸³à¹€à¸›à¹‡à¸™
â€¢ à¸ªà¹ˆà¸‡à¸§à¸±à¸™à¸–à¸±à¸”à¹„à¸› à¸–à¸¶à¸‡à¸ à¸²à¸¢à¹ƒà¸™ 1-3 à¸§à¸±à¸™à¸„à¸£à¸±à¸š
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
6) à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸ªà¸´à¸™à¸„à¹‰à¸²à¹à¸šà¸šà¹€à¸•à¹‡à¸¡
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(à¸) à¹à¸­à¸›à¸£à¸´à¸„à¸­à¸•à¹à¸«à¹‰à¸‡à¹„à¸£à¹‰à¹€à¸¡à¸¥à¹‡à¸”à¸ˆà¸²à¸à¸•à¸¸à¸£à¸à¸µ
   â€¢ à¸„à¸¸à¸“à¸„à¹ˆà¸²à¸—à¸²à¸‡à¹‚à¸ à¸Šà¸™à¸²à¸à¸²à¸£ (à¸•à¹ˆà¸­ 100 à¸à¸£à¸±à¸¡): 
       - à¸žà¸¥à¸±à¸‡à¸‡à¸²à¸™ ~241 à¸à¸´à¹‚à¸¥à¹à¸„à¸¥à¸­à¸£à¸µ
       - à¸„à¸²à¸£à¹Œà¹‚à¸šà¹„à¸®à¹€à¸”à¸£à¸• 63 à¸à¸£à¸±à¸¡ (à¸™à¹‰à¸³à¸•à¸²à¸¥ ~53 à¸à¸£à¸±à¸¡)
       - à¹ƒà¸¢à¸­à¸²à¸«à¸²à¸£ ~7 à¸à¸£à¸±à¸¡
       - à¹‚à¸›à¸£à¸•à¸µà¸™ 3.4 à¸à¸£à¸±à¸¡
       - à¸¡à¸µà¸§à¸´à¸•à¸²à¸¡à¸´à¸™à¹€à¸­, à¹‚à¸žà¹à¸—à¸ªà¹€à¸‹à¸µà¸¢à¸¡à¸ªà¸¹à¸‡
   â€¢ à¸›à¸£à¸°à¹‚à¸¢à¸Šà¸™à¹Œ: à¸šà¸³à¸£à¸¸à¸‡à¸ªà¸²à¸¢à¸•à¸², à¹€à¸ªà¸£à¸´à¸¡à¸à¸£à¸°à¸”à¸¹à¸, à¸Šà¹ˆà¸§à¸¢à¸¢à¹ˆà¸­à¸¢à¸­à¸²à¸«à¸²à¸£, à¸•à¹‰à¸²à¸™à¸­à¸™à¸¸à¸¡à¸¹à¸¥à¸­à¸´à¸ªà¸£à¸°
   â€¢ à¸‚à¹‰à¸­à¸„à¸§à¸£à¸£à¸°à¸§à¸±à¸‡: à¸™à¹‰à¸³à¸•à¸²à¸¥à¸˜à¸£à¸£à¸¡à¸Šà¸²à¸•à¸´à¸ªà¸¹à¸‡ à¸„à¸§à¸£à¸£à¸±à¸šà¸›à¸£à¸°à¸—à¸²à¸™à¸žà¸­à¸”à¸µ
   â€¢ à¹‚à¸›à¸£à¹‚à¸¡à¸Šà¸±à¹ˆà¸™:
       - 1 à¸–à¸¸à¸‡ = 98 à¸šà¸²à¸— à¸£à¸§à¸¡à¸ªà¹ˆà¸‡ 139.-
       - 2 à¸–à¸¸à¸‡ = 180 à¸šà¸²à¸— (à¸ªà¹ˆà¸‡à¸Ÿà¸£à¸µ)
       - 3 à¸–à¸¸à¸‡ = 250 à¸šà¸²à¸— (à¸ªà¹ˆà¸‡à¸Ÿà¸£à¸µ)
     (à¸ à¸²à¸¢à¹ƒà¸™ 3 à¸§à¸±à¸™)
   â€¢ à¹€à¸à¹‡à¸šà¹€à¸‡à¸´à¸™à¸›à¸¥à¸²à¸¢à¸—à¸²à¸‡à¹„à¸”à¹‰
   â€¢ à¹‚à¸­à¸™à¸ˆà¹ˆà¸²à¸¢à¹„à¸”à¹‰
   â€¢ à¸«à¸²à¸à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸”à¸¹à¸£à¸¹à¸›à¸ à¸²à¸ž: â€œ[SEND_IMAGE_APRICOT:https://i.imgur.com/XY0Nz82.jpeg]â€

---------------------------------------------------------------
(à¹€à¸žà¸´à¹ˆà¸¡) à¸«à¸²à¸à¸¥à¸¹à¸à¸„à¹‰à¸²à¸•à¹‰à¸­à¸‡à¸à¸²à¸£ â€œà¹‚à¸­à¸™à¸ˆà¹ˆà¸²à¸¢â€ à¸«à¸£à¸·à¸­à¸–à¸²à¸¡ â€œà¸‚à¸­à¹€à¸¥à¸‚à¸šà¸±à¸à¸Šà¸µâ€ à¸«à¸£à¸·à¸­ â€œà¹‚à¸­à¸™à¸œà¹ˆà¸²à¸™à¸˜à¸™à¸²à¸„à¸²à¸£â€:
- à¹ƒà¸«à¹‰à¹à¸ˆà¹‰à¸‡à¹€à¸¥à¸‚à¸šà¸±à¸à¸Šà¸µà¸•à¸²à¸¡à¸™à¸µà¹‰: 116-1431-865 à¸Šà¸·à¹ˆà¸­à¸šà¸±à¸à¸Šà¸µ à¸¨à¸´à¸£à¸´à¸¥à¸±à¸à¸©à¸“à¹Œ à¸¡à¸¹à¸¥à¹„à¸Šà¸¢ (à¸à¸ªà¸´à¸à¸£à¹„à¸—à¸¢)
- à¹à¸¥à¸°à¹ƒà¸«à¹‰à¸ªà¹ˆà¸‡à¸£à¸¹à¸›à¸ à¸²à¸žà¹à¸™à¸šà¸”à¹‰à¸§à¸¢: "[SEND_IMAGE_PAYMENT:https://i.imgur.com/gS0on5c.png]"

â€¢ à¸«à¸²à¸à¸¥à¸¹à¸à¸„à¹‰à¸²à¸ªà¸™à¹ƒà¸ˆà¹‚à¸­à¸™à¸ˆà¹ˆà¸²à¸¢: à¸ªà¹ˆà¸‡à¸ à¸²à¸žà¸Šà¹ˆà¸­à¸‡à¸—à¸²à¸‡à¹‚à¸­à¸™ "[SEND_IMAGE_PAYMENT:https://i.imgur.com/gS0on5c.png]"
`;

// ------------------------
// Facebook Webhook Verify
// ------------------------
app.get('/webhook', (req, res) => {
  const mode = req.query['hub.mode'];
  const token = req.query['hub.verify_token'];
  const challenge = req.query['hub.challenge'];

  if (mode === 'subscribe' && token === VERIFY_TOKEN) {
    res.status(200).send(challenge);
  } else {
    res.sendStatus(403);
  }
});

// ------------------------
// Facebook Webhook Receiver
// ------------------------
app.post('/webhook', async (req, res) => {
  if (req.body.object === 'page') {
    for (const entry of req.body.entry) {
      const webhookEvent = entry.messaging[0];
      const senderId = webhookEvent.sender.id;

      if (webhookEvent.message && webhookEvent.message.text) {
        const messageText = webhookEvent.message.text;
        const history = await getChatHistory(senderId);
        const assistantResponse = await getAssistantResponse(history, messageText);
        await saveChatHistory(senderId, messageText, assistantResponse);
        sendTextMessage(senderId, assistantResponse);
      }
      else if (webhookEvent.message && webhookEvent.message.attachments) {
        const attachments = webhookEvent.message.attachments;
        const isImageFound = attachments.some(att => att.type === 'image');

        if (isImageFound) {
          const userMessage = "**à¸¥à¸¹à¸à¸„à¹‰à¸²à¸ªà¹ˆà¸‡à¸£à¸¹à¸›à¸¡à¸²**";
          const history = await getChatHistory(senderId);
          const assistantResponse = await getAssistantResponse(history, userMessage);
          await saveChatHistory(senderId, userMessage, assistantResponse);
          sendTextMessage(senderId, assistantResponse);
        } else {
          const userMessage = "**à¸¥à¸¹à¸à¸„à¹‰à¸²à¸ªà¹ˆà¸‡à¹„à¸Ÿà¸¥à¹Œà¹à¸™à¸šà¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¸£à¸¹à¸›**";
          const history = await getChatHistory(senderId);
          const assistantResponse = await getAssistantResponse(history, userMessage);
          await saveChatHistory(senderId, userMessage, assistantResponse);
          sendTextMessage(senderId, assistantResponse);
        }
      }
    }
    res.status(200).send('EVENT_RECEIVED');
  } else {
    res.sendStatus(404);
  }
});

// ------------------------
// à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™: à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ MongoDB (Global client)
// ------------------------
async function connectDB() {
  if (!mongoClient) {
    mongoClient = new MongoClient(MONGO_URI);
    await mongoClient.connect();
    console.log("MongoDB connected (global client).");
  }
  return mongoClient;
}

// ------------------------
// à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™: getChatHistory
// ------------------------
async function getChatHistory(senderId) {
  try {
    const client = await connectDB();
    const db = client.db("chatbot");
    const collection = db.collection("chat_history");

    const chats = await collection.find({ senderId }).toArray();
    return chats.map(chat => ({
      role: "user",
      content: chat.message,
    }));
  } catch (error) {
    console.error("Error fetching chat history:", error);
    return [];
  }
}

// ------------------------
// à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™: getAssistantResponse
// ------------------------
async function getAssistantResponse(history, message) {
  try {
    const messages = [
      { role: "system", content: systemInstructions },
      ...history,
      { role: "user", content: message },
    ];

    const response = await openai.chat.completions.create({
      model: "gpt-4o", // à¸«à¸£à¸·à¸­ gpt-3.5-turbo à¸¯à¸¥à¸¯
      messages: messages,
    });
    return response.choices[0].message.content;
  } catch (error) {
    console.error("Error with ChatGPT Assistant:", error);
    return "à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸à¸±à¸š Assistant";
  }
}

// ------------------------
// à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™: saveChatHistory
// ------------------------
async function saveChatHistory(senderId, message, response) {
  try {
    const client = await connectDB();
    const db = client.db("chatbot");
    const collection = db.collection("chat_history");

    const chatRecord = {
      senderId,
      message,
      response,
      timestamp: new Date(),
    };
    await collection.insertOne(chatRecord);
    console.log("à¸šà¸±à¸™à¸—à¸¶à¸à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¹à¸Šà¸—à¸ªà¸³à¹€à¸£à¹‡à¸ˆ");
  } catch (error) {
    console.error("Error saving chat history:", error);
  }
}

// ------------------------
// à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™: sendTextMessage
// ------------------------
function sendTextMessage(senderId, response) {
  // à¸ˆà¸±à¸š 2 à¸à¸£à¸“à¸µ: [SEND_IMAGE_APRICOT:..] à¹à¸¥à¸° [SEND_IMAGE_PAYMENT:..]
  const apricotRegex = /\[SEND_IMAGE_APRICOT:(https?:\/\/[^\s]+)\]/g;
  const paymentRegex = /\[SEND_IMAGE_PAYMENT:(https?:\/\/[^\s]+)\]/g;

  // matchAll
  const apricotMatches = [...response.matchAll(apricotRegex)];
  const paymentMatches = [...response.matchAll(paymentRegex)];

  // à¸•à¸±à¸”à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸­à¸­à¸à¸ˆà¸²à¸ response
  let textPart = response
    .replace(apricotRegex, '')
    .replace(paymentRegex, '')
    .trim();

  // à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸›à¸à¸•à¸´
  if (textPart.length > 0) {
    sendSimpleTextMessage(senderId, textPart);
  }

  // à¸ªà¹ˆà¸‡à¸£à¸¹à¸›à¹à¸­à¸›à¸£à¸´à¸„à¸­à¸•
  apricotMatches.forEach(match => {
    const imageUrl = match[1];
    sendImageMessage(senderId, imageUrl);
  });

  // à¸ªà¹ˆà¸‡à¸£à¸¹à¸›à¸Šà¹ˆà¸­à¸‡à¸—à¸²à¸‡à¹‚à¸­à¸™
  paymentMatches.forEach(match => {
    const imageUrl = match[1];
    sendImageMessage(senderId, imageUrl);
  });
}

// ------------------------
// à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™: sendSimpleTextMessage
// ------------------------
function sendSimpleTextMessage(senderId, text) {
  const requestBody = {
    recipient: { id: senderId },
    message: { text },
  };

  request({
    uri: 'https://graph.facebook.com/v12.0/me/messages',
    qs: { access_token: PAGE_ACCESS_TOKEN },
    method: 'POST',
    json: requestBody,
  }, (err) => {
    if (!err) {
      console.log('à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸–à¸¹à¸à¸ªà¹ˆà¸‡à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!');
    } else {
      console.error('à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡:', err);
    }
  });
}

// ------------------------
// à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™: sendImageMessage
// ------------------------
function sendImageMessage(senderId, imageUrl) {
  const requestBody = {
    recipient: { id: senderId },
    message: {
      attachment: {
        type: 'image',
        payload: {
          url: imageUrl,
          is_reusable: true,
        },
      },
    },
  };

  request({
    uri: 'https://graph.facebook.com/v12.0/me/messages',
    qs: { access_token: PAGE_ACCESS_TOKEN },
    method: 'POST',
    json: requestBody,
  }, (err) => {
    if (!err) {
      console.log('à¸£à¸¹à¸›à¸ à¸²à¸žà¸–à¸¹à¸à¸ªà¹ˆà¸‡à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!');
    } else {
      console.error('à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸ªà¹ˆà¸‡à¸£à¸¹à¸›à¸ à¸²à¸ž:', err);
    }
  });
}

// ------------------------
// Start Server
// ------------------------
app.listen(PORT, async () => {
  console.log(`Server is running on port ${PORT}`);
  // à¹€à¸Šà¸·à¹ˆà¸­à¸¡ MongoDB à¸•à¸­à¸™ start server
  try {
    await connectDB();
  } catch (err) {
    console.error("MongoDB connect error at startup:", err);
  }
});
